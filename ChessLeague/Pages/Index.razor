@page "/"
@using System.Net.Http
@using System.Text.Json
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components.Web
@inject HttpClient Http


<div class="row header">
    <div class="col-auto">
        @* <h2>All Time Stats</h2> *@
    </div>
    <div class="col text-center" id="season-header">
        <select value="@selectedSeason" @onchange="getParticitpants" >
            @if (seasonsList == null)
            {
                <option value="loading">Loading Seasons...</option>
            }
            else if (seasonsList.Length == 0)
            {
                <p>No seasons found.</p>
            }else{
                @foreach (var season in seasonsList)
                {
                    <option value="@season.ID">@season.Name</option>
                }
            }
            <option value="addSeason" id="addSeasonBtn">
                <button class="dropdown-item btn btn-primary">Add New Season</button>
            </option>
        </select>
    </div>
</div>

<div class="standings-wrapper">
    
    <div class="row">
        <div class="col name-col">
            Player
        </div>
        <div class="col"  style="display: @((advancedView ? "block;" : "none;"))" >
            Player ID
        </div>
        <div class="col-auto rating-col">
            Rating
        </div>
        <div class="col rating-col"  style="display: @((advancedView ? "block;" : "none;"))" >
            Highest Rating
        </div>
        <div class="col record-col"  style="display: @((advancedView ? "block;" : "none;"))" >
            Win Streak
        </div>
        <div class="col record-col"  style="display: @((advancedView ? "block;" : "none;"))" >
            Highest Win Streak
        </div>
        <div class="col record-col">
            Wins
        </div>
        <div class="col record-col">
            Losses
        </div>
        <div class="col record-col">
            Draws
        </div>
    </div>

    @if (players == null || players.Length == 0)
    {
        <option value="addSeason" id="addSeasonBtn">
            <div class="col name-col">
                No Players Found
            </div>
        </option>
    }
    else
    {
        @foreach (var player in players)
        {
            <div class="row">
                <div class="col name-col">
                    @player.Player.Name
                </div>
                <div class="col"  style="display: @((advancedView ? "block;" : "none;"))" >
                    @player.Player.Id
                </div>
                <div class="col-auto rating-col">
                    @player.Stats.Rating
                </div>
                <div class="col rating-col"  style="display: @((advancedView ? "block;" : "none;"))" >
                    @player.Stats.HighestRating
                </div>
                <div class="col record-col">
                    @player.Stats.Wins
                </div>
                <div class="col record-col">
                    @player.Stats.Losses
                </div>
                <div class="col record-col">
                    @player.Stats.Draws
                </div>
                <div class="col-auto float-right"  style="margin-left: auto;">
                    <button @onclick="(() => StartGame(player.Player.Id))" class="btn btn-primary" >@((game.Light != 0 ?  game.Light == player.Player.Id ? "End Game" : "Player 2" : "Start Game"))</button>
                </div>
                @* <div class="col-auto float-right"  style="margin-left: auto;">
                    <button @onclick="(() => AdvancedViewOpen(player.Player))" class="btn btn-primary" >@((advancedView ? "Close View" : "Advanced view"))</button>
                </div> *@
            </div>
        }
    }
    <div class="row">
        <div class="col-auto"  style="margin-left: auto;">
            <select value="none" id="add-player-to-season" @onchange="getParticitpants">
                <option value="none" selected disabled hidden>Add Player to Season</option>
                @if (allPlayers == null )
                {
                    <option value="addSeason" id="addPlayerToSeasonBtn">
                        <p>NO Players Found</p>
                    </option>
                }else{
                    @foreach (var player in allPlayers)
                    {
                        <option value="addSeason" id="addPlayerToSeasonBtn">
                            <button class="dropdown-item btn btn-primary" value="@player.Id" @onclick="(e) => addPlayerToSeason(e, player.Id)">@player.Name</button>
                        </option>
                    }
                }
            </select>
        </div>
    </div>
</div>
<button class="btn btn-primary" @onclick="modalPlayer.Show">Register New Player</button>
<a href="/CreateSeason" asp-page="/CreateSeason" class="btn btn-primary">Create Season</a>
@* <a href="/Tournament" asp-page="/Tournament" class="btn btn-primary">Go to Season</a> *@
@* <a href="/CreateTournament" asp-page="/CreateTournament" class="btn btn-primary">Create Tournament</a> *@
@* <a href="/Tournament" asp-page="/Tournament" class="btn btn-primary">Go to Tournament Page</a> *@


<!-- Register a Player --> 
<Modal @ref="modalPlayer" ModalTitle="Register a Player" >
    <RegisterPlayer modal="@modalPlayer">
    </RegisterPlayer>
</Modal>
<!-- Game a Player --> 
<Modal @ref="modalGame" ModalTitle="Register Game" >
    <RegisterGame modal="@modalGame" selectedSeason="@selectedSeason" game="game">
    </RegisterGame>
</Modal>

<!-- Live Game -->

@code {
    // List of players for standings
    public PlayerStats[]? players = null;
    public Season[]? seasonsList = null;
    public string selectedSeason = "loading";
    private Game game = new Game();
    // Season the screen is displaying
    private string errorMessage = string.Empty;
    private bool advancedView   = false;
    /* Sign Up Variables*/
    private Modal modalPlayer = new Modal();
    private Modal modalGame = new Modal();

    // List of all players, for add player to season list
    private List<Player> allPlayers = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get list of seasons
            var response = await Http.GetAsync("https://lrs-chess-ratings.com/seasons?with_deleted=false&page_id=0");
            response.EnsureSuccessStatusCode();
            seasonsList = JsonSerializer.Deserialize<SeasonsResponse>(await response.Content.ReadAsStringAsync(),
                                                                     new JsonSerializerOptions { PropertyNameCaseInsensitive = true }).Items;

            selectedSeason = seasonsList[seasonsList.Length-1].ID.ToString();

            // If there are seasons get the list of players for the season
            if (seasonsList.Length != 0 && seasonsList != null)
            {

            var response2 = await Http.PostAsync("https://lrs-chess-ratings.com/season/" + selectedSeason + ":getParticipants", new StringContent("", System.Text.Encoding.UTF8, "application/json"));
            response2.EnsureSuccessStatusCode();

            players = JsonSerializer.Deserialize<PlayerStats[]>(await response2.Content.ReadAsStringAsync(),
                                                                 new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            foreach (var player in players){
                Console.WriteLine("PLayer: " + player.Player.Name);
            }

            var response3 = await Http.GetAsync("https://lrs-chess-ratings.com/players");
            response3.EnsureSuccessStatusCode();
            allPlayers = JsonSerializer.Deserialize<allPlayersResponse>(await response3.Content.ReadAsStringAsync(),
                                                                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true }).Items.ToList();

            foreach (var player in allPlayers){
                Console.WriteLine("AllPLayer: " + player.Name);
            }
            }
            
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "Error retrieving players. Please try again later.";
            // log or display the error message as needed
        }
        catch (JsonException ex)
        {
            errorMessage = "Error parsing player data. Please try again later.";
            // log or display the error message as needed
        }
        
        StateHasChanged(); 
        
    }
    public class SeasonsResponse
    {
        public Season[] Items { get; set; }
        public int NextPage { get; set; }
    }
    
    public class allPlayersResponse
    {
        public Player[] Items { get; set; }
        public int NextPage { get; set; }
    }


    private void StartGame(uint PlayerID){
        // Player has been click twice, then close end game
        if (game.Light == PlayerID){
            game.Light = 0;
        }else
        // First Player has not been chosen
        if (game.Light == 0){
            game.Light = PlayerID;
        }else {
            game.Dark = PlayerID;
            modalGame.Show();
        }

    }
    public async void addPlayerToSeason(MouseEventArgs e, uint playerId){
        try
        {
            @* e.PreventDefault(); *@
            // If there are seasons get the list of players for the season
            var response = await Http.PostAsync("https://lrs-chess-ratings.com/season/" + selectedSeason + ":addPlayer?player_id=" + playerId , new StringContent("", System.Text.Encoding.UTF8, "application/json"));
            response.EnsureSuccessStatusCode();

            players = JsonSerializer.Deserialize<PlayerStats[]>(await response.Content.ReadAsStringAsync(),
                                                                 new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            //Remove Player from all Players list
            foreach (var player in allPlayers){
                if (player.Id.ToString().CompareTo(playerId) == 0){
                    allPlayers.Remove(player);
                }
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "Error retrieving players. Please try again later.";
            // log or display the error message as needed
        }
        catch (JsonException ex)
        {
            errorMessage = "Error parsing player data. Please try again later.";
            // log or display the error message as needed
        }
        StateHasChanged();
    }
    public async void getParticitpants(ChangeEventArgs e){
        try
        {
            selectedSeason = e.Value.ToString();
            // If there are seasons get the list of players for the season
            var response2 = await Http.PostAsync("https://lrs-chess-ratings.com/season/" + selectedSeason + ":getParticipants", new StringContent("", System.Text.Encoding.UTF8, "application/json"));
            response2.EnsureSuccessStatusCode();

            players = JsonSerializer.Deserialize<PlayerStats[]>(await response2.Content.ReadAsStringAsync(),
                                                                 new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "Error retrieving players. Please try again later.";
            // log or display the error message as needed
        }
        catch (JsonException ex)
        {
            errorMessage = "Error parsing player data. Please try again later.";
            // log or display the error message as needed
        }
        StateHasChanged();
    }
    public async void getAllPlayersList(){
        try
        {
            // Get list of seasons
            var response = await Http.GetAsync("https://lrs-chess-ratings.com/players");
            response.EnsureSuccessStatusCode();
            allPlayers = JsonSerializer.Deserialize<allPlayersResponse>(await response.Content.ReadAsStringAsync(),
                                                                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true }).Items.ToList();

            foreach (var p1 in allPlayers){
                foreach (var p2 in players){
                    if (p1.Id == p2.Player.Id){
                        allPlayers.Remove(p1);
                    }
                }
            }         
        }
        catch (HttpRequestException ex)
        {
            errorMessage = "Error retrieving players. Please try again later.";
            // log or display the error message as needed
        }
        catch (JsonException ex)
        {
            errorMessage = "Error parsing player data. Please try again later.";
            // log or display the error message as needed
        }
    }

}
